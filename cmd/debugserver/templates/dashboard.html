<!DOCTYPE html>
<html>
    <head>
        <title>DHT Network Monitor</title>
        <script src="https://d3js.org/d3.v7.min.js"></script>
        <style>
            :root {
                --terminal-color: #00c8ff;
                --terminal-bg: #0d0208;
                --grid-color: rgba(0, 200, 255, 0.05);
            }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
                font-family: "VT323", "Source Code Pro", "Monaco", monospace;
                color: var(--terminal-color);
            }

            body {
                background: var(--terminal-bg);
                min-height: 100vh;
                padding: 20px;
                background-image: linear-gradient(
                        var(--grid-color) 1px,
                        transparent 1px
                    ),
                    linear-gradient(
                        90deg,
                        var(--grid-color) 1px,
                        transparent 1px
                    );
                background-size: 20px 20px;
            }

            h1 {
                font-size: 24px;
                margin-bottom: 20px;
                text-transform: uppercase;
                letter-spacing: 2px;
                text-align: center;
            }

            .dashboard {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
                max-width: 1400px;
                margin: 0 auto;
            }

            .panel {
                background: var(--terminal-bg);
                border: 1px solid var(--terminal-color);
                padding: 15px;
            }

            .panel h2 {
                font-size: 16px;
                margin-bottom: 15px;
                text-transform: uppercase;
            }

            pre {
                font-size: 12px;
                line-height: 1.4;
                overflow-x: auto;
                padding: 10px;
                background: rgba(0, 200, 255, 0.03);
            }

            #ring {
                grid-column: 1 / -1;
            }

            .node circle {
                fill: var(--terminal-bg);
                stroke: var(--terminal-color);
                stroke-width: 2px;
            }

            .label {
                fill: var(--terminal-color);
                font-size: 10px;
            }

            ::-webkit-scrollbar {
                width: 8px;
                height: 8px;
            }

            ::-webkit-scrollbar-track {
                background: var(--terminal-bg);
            }

            ::-webkit-scrollbar-thumb {
                background: var(--terminal-color);
            }

            .connection {
                fill: none;
                stroke: rgba(0, 200, 255, 0.2);
                stroke-width: 1;
            }
        </style>
    </head>
    <body>
        <h1>DHT Network Monitor</h1>
        <div class="dashboard">
            <div class="panel" id="nodes">
                <h2>Network Nodes</h2>
            </div>
            <div class="panel" id="data">
                <h2>Distributed Data</h2>
            </div>
            <div class="panel" id="ring">
                <h2>Network Topology</h2>
            </div>
        </div>
        <script>
            let svg, container;
            const width = 800;
            const height = 400;
            const radius = Math.min(width, height) / 2 - 60;

            function initializeSVG() {
                svg = d3
                    .select("#ring")
                    .append("svg")
                    .attr("width", width)
                    .attr("height", height);

                container = svg
                    .append("g")
                    .attr("transform", `translate(${width / 2},${height / 2})`);

                // Add concentric circles for grid
                const gridCircles = [0.25, 0.5, 0.75, 1];
                gridCircles.forEach((factor) => {
                    container
                        .append("circle")
                        .attr("r", radius * factor)
                        .attr("fill", "none")
                        .attr("stroke", "rgba(0, 200, 255, 0.1)")
                        .attr("stroke-width", 1);
                });
            }

            function refreshData() {
                fetch("/api/nodes")
                    .then((r) => r.json())
                    .then((nodes) => {
                        d3.select("#nodes").html(`
                    <h2>Network Nodes (${nodes.length})</h2>
                    <pre>${JSON.stringify(nodes, null, 2)}</pre>
                `);
                    });

                fetch("/api/data")
                    .then((r) => r.json())
                    .then((data) => {
                        d3.select("#data").html(`
                    <h2>Distributed Data</h2>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `);
                    });

                fetch("/api/ring")
                    .then((r) => r.json())
                    .then((ringData) => {
                        updateRing(ringData);
                    });
            }

            function updateRing(ringData) {
                if (!svg) initializeSVG();

                const angleScale = d3
                    .scaleLinear()
                    .domain([0, ringData.length])
                    .range([0, 2 * Math.PI]);

                // Update connections
                const connections = container
                    .selectAll(".connection")
                    .data(ringData);

                // Remove old connections
                connections.exit().remove();

                // Add new connections and update existing ones
                connections
                    .enter()
                    .append("path")
                    .attr("class", "connection")
                    .merge(connections)
                    .attr("d", (d, i) => {
                        const startAngle = angleScale(i);
                        const endAngle = angleScale((i + 1) % ringData.length);
                        return d3.arc()({
                            innerRadius: radius,
                            outerRadius: radius,
                            startAngle: startAngle,
                            endAngle: endAngle,
                        });
                    });

                // Update nodes
                const nodes = container.selectAll(".node").data(ringData);

                // Remove old nodes
                nodes.exit().remove();

                // Add new nodes
                const newNodes = nodes
                    .enter()
                    .append("g")
                    .attr("class", "node");

                newNodes.append("circle").attr("r", 6);

                newNodes
                    .append("text")
                    .attr("class", "label")
                    .attr("dy", ".35em")
                    .attr("x", 0)
                    .attr("y", -15);

                // Update all nodes
                container
                    .selectAll(".node")
                    .attr("transform", (d, i) => {
                        const angle = angleScale(i);
                        const x = radius * Math.cos(angle - Math.PI / 2);
                        const y = radius * Math.sin(angle - Math.PI / 2);
                        return `translate(${x},${y})`;
                    })
                    .select("text")
                    .text((d, i) => `Node ${i + 1}`);
            }

            setInterval(refreshData, 1000);
            refreshData();
        </script>
    </body>
</html>
